name: Daily Investment Analysis

on:
  schedule:
    # ë§¤ì¼ í•œêµ­ì‹œê°„ ì˜¤ì „ 8ì‹œ (UTC 23:00 ì „ë‚ )
    - cron: '0 23 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

# GitHub Pages ë°°í¬ë¥¼ ìœ„í•œ ê¶Œí•œ ì„¤ì •
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Run analysis script
        env:
          NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: node scripts/daily-analysis.mjs

      - name: Save analysis result
        uses: actions/upload-artifact@v4
        with:
          name: daily-analysis-${{ github.run_number }}
          path: output/
          retention-days: 30

      # GitHub Pagesìš© íŒŒì¼ ì¤€ë¹„
      - name: Prepare GitHub Pages
        run: |
          mkdir -p docs
          # ìµœì‹  ë¶„ì„ ê²°ê³¼ë¥¼ index.htmlë¡œ ë³µì‚¬
          LATEST_HTML=$(ls -t output/*.html 2>/dev/null | head -1)
          if [ -n "$LATEST_HTML" ]; then
            cp "$LATEST_HTML" docs/index.html
            echo "âœ… Dashboard prepared: $LATEST_HTML -> docs/index.html"
          fi
          # JSONë„ ë³µì‚¬ (APIì²˜ëŸ¼ ì‚¬ìš© ê°€ëŠ¥)
          LATEST_JSON=$(ls -t output/*.json 2>/dev/null | head -1)
          if [ -n "$LATEST_JSON" ]; then
            cp "$LATEST_JSON" docs/latest.json
          fi
          # ížˆìŠ¤í† ë¦¬ ë³´ê´€
          cp output/*.html docs/ 2>/dev/null || true
          cp output/*.json docs/ 2>/dev/null || true

      - name: Commit and push to GitHub Pages
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/
          git commit -m "ðŸ“Š Daily analysis update - $(date +'%Y-%m-%d')" || echo "No changes to commit"
          git push
